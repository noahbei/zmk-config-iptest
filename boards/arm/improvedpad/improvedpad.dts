/dts-v1/;
 #include <st/f3/stm32f303Xc.dtsi>
 #include <st/f3/stm32f303c(b-c)tx-pinctrl.dtsi>
 #include <dt-bindings/zmk/matrix_transform.h>
 
 / {
     model = "Improvedpad, v1";
     compatible = "improvedpad,v1";
 
     chosen {
         zephyr,sram = &sram0;
         zephyr,flash = &flash0;
         zmk,kscan = &kscan0;
         zmk,matrix-transform = &default_transform;
     };
 
     kscan0: kscan {
        compatible = "zmk,kscan-gpio-matrix";
        wakeup-source;

        diode-direction = "col2row";
        row-gpios
            = <&expander 7 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            , <&expander 6 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            , <&expander 5 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            , <&expander 4 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            ;
        col-gpios
            = <&expander 0 GPIO_ACTIVE_HIGH>
            , <&expander 1 GPIO_ACTIVE_HIGH>
            , <&expander 2 GPIO_ACTIVE_HIGH>
            , <&expander 3 GPIO_ACTIVE_HIGH>
            , <&expander 11 GPIO_ACTIVE_HIGH>
            , <&expander 8 GPIO_ACTIVE_HIGH>
            ;
    };
 
    expander: mcp23s17@20 {
        compatible = "microchip,mcp23s17";
        reg = <0x20>;
        spi-max-frequency = <1000000>;
        gpio-controller;
        #gpio-cells = <2>;
        #ngpios = <16>;
        // maybe only available with microchip,mcp23sxx
        // reset-gpios = <&gpio0 18 GPIO_ACTIVE_LOW>;
        status = "okay";
    };

    &spi1 {
        status = "okay";
        sck-pin = <17>;
        mosi-pin = <14>;
        miso-pin = <15>;
        cs-gpios = <&gpio0 11 GPIO_ACTIVE_LOW>;
    };

     encoder: encoder {
         compatible = "alps,ec11";
         a-gpios = <&expander 12 GPIO_PULL_UP>;
         b-gpios = <&expander 13 GPIO_PULL_UP>;
         steps = <80>;
         status = "okay";
     };
 
     sensors: sensors {
         compatible = "zmk,keymap-sensors";
         sensors = <&encoder>;
         triggers-per-rotation = <20>;
     };
 
    zephyr_udc0: &usb {
        pinctrl-0 = <&usb_dm_pa11 &usb_dp_pa12>;
        pinctrl-names = "default";
        status = "okay";
    };
 
//  &clk_hse {
//      status = "okay";
//      clock-frequency = <DT_FREQ_M(8)>;
//  };
 
//  &pll {
//      prediv = <1>;
//      mul = <9>;
//      clocks = <&clk_hse>;
//      status = "okay";
//  };
 
//  &rcc {
//      clocks = <&pll>;
//      clock-frequency = <DT_FREQ_M(72)>;
//      ahb-prescaler = <1>;
//      apb1-prescaler = <2>;
//      apb2-prescaler = <1>;
//  };
 
//  &flash0 {
//      /*
//       * For more information, see:
//       * http://docs.zephyrproject.org/latest/guides/dts/index.html#flash-partitions
//       */
//      partitions {
//          compatible = "fixed-partitions";
//          #address-cells = <1>;
//          #size-cells = <1>;
 
//          /* Set 6Kb of storage at the end of the 256Kb of flash */
//          storage_partition: partition@3e800 {
//              reg = <0x0003e800 0x00001800>;
//          };
//      };
//  };